# Microsoft Teams Employee App - Falcon SCS Deployment Guide

## 📋 Overview

This guide documents the complete deployment process for the Microsoft Teams Employee App to Salesforce's Falcon SCS (Static Content Service) infrastructure, including all troubleshooting steps and solutions discovered during the deployment.

## 🏗️ Project Structure

```
msteams-employee-app/
├── dist/                     # Built React application files
├── certificates/             # mTLS certificates for Falcon authentication
│   ├── client.pem           # Client certificate
│   ├── client-key.pem       # Client private key
│   └── cacerts.pem          # Certificate Authority certificate
├── scsCopyBinary/           # Deployment tool
│   └── scsCopy              # Binary for uploading to Falcon SCS
├── upload.sh                # Original bash deployment script
├── upload.ps1               # PowerShell deployment script (Windows)
├── upload-stage.ps1         # Stage environment deployment
├── upload-prod.ps1          # Production environment deployment
├── deployment-config.json   # Environment configuration reference
└── Dockerfile               # Container configuration
```

## 🚀 Quick Start

### Prerequisites
- Node.js (18, 20, or 22)
- Valid mTLS certificates in `certificates/` directory
- Access to Salesforce Falcon infrastructure
- Windows PowerShell (for .ps1 scripts) or Bash (for .sh scripts)

### Deployment Commands

```powershell
# Build the application
npm run build

# Deploy to Production (recommended)
.\upload-prod.ps1

# Deploy to Stage (limited functionality)
.\upload-stage.ps1
```

## 🌐 Access URLs

### Production Environment (Working)
- **Main App**: https://cdn.scs.static.lightning.force.com/agent-svc-messaging/index.html
- **Teams Tab**: https://cdn.scs.static.lightning.force.com/agent-svc-messaging/index.html#/tab
- **Auth Pages**: 
  - https://cdn.scs.static.lightning.force.com/agent-svc-messaging/auth-start.html
  - https://cdn.scs.static.lightning.force.com/agent-svc-messaging/auth-end.html

### Stage Environment (No Web Access)
- Files deploy successfully but are not web-accessible
- CDN endpoint `stage.cdn.scs.static.lightning.force.com` does not exist

## 🏭 Environment Configuration

| Environment | Falcon Instance | CDN Endpoint | Web Access | Use Case |
|-------------|----------------|--------------|------------|----------|
| **dev** | `dev1-uswest2` | None | ❌ No | Internal development |
| **stage** | `stage1-uswest2` | None | ❌ No | Testing (no web serving) |
| **prod** | `prod1-uswest2` | `cdn.scs.static.lightning.force.com` | ✅ Yes | Live deployment |

## 🔧 Troubleshooting Guide

### Issue 1: "Open with" Dialog Appears

**Symptoms:**
- Running `scsCopy` triggers Windows "Choose an app" dialog
- Multiple browser tabs open unexpectedly
- Deployment gets stuck during file upload

**Solution:**
```powershell
# Unblock the binary
Unblock-File -Path ".\scsCopyBinary\scsCopy"

# Stop any stuck processes
taskkill /f /im "scsCopy*" 2>$null
Get-Process | Where-Object {$_.ProcessName -like "*scs*"} | Stop-Process -Force -ErrorAction SilentlyContinue
```

**Root Cause:** Windows marks downloaded executables as blocked, preventing normal execution.

### Issue 2: CDN Shows Blank Page

**Symptoms:**
- Browser opens but shows empty/blank page
- URL appears correct but no content loads
- No error messages displayed

**Possible Solutions:**

1. **Check URL Pattern:**
   ```
   ✅ Correct: https://cdn.scs.static.lightning.force.com/agent-svc-messaging/index.html
   ❌ Wrong:   https://cdn.scs.static.lightning.force.com/resources/agent-svc-messaging/index.html
   ```

2. **Verify Deployment:**
   ```powershell
   # Test if base CDN is accessible
   Invoke-WebRequest -Uri "https://cdn.scs.static.lightning.force.com/" -UseBasicParsing
   
   # Test your specific app
   Invoke-WebRequest -Uri "https://cdn.scs.static.lightning.force.com/agent-svc-messaging/index.html" -UseBasicParsing
   ```

3. **Check Browser Network Tab:**
   - Look for 404 errors on asset files
   - Verify all CSS/JS files are loading correctly
   - Check for CORS issues

### Issue 3: 404 Not Found Errors

**Symptoms:**
- HTTP 404 errors when accessing deployed URLs
- Files uploaded successfully but not accessible via web

**Diagnosis Steps:**

1. **Verify Environment:**
   ```powershell
   # Check if you're using the right environment
   echo $env:ENVIRONMENT_TYPE
   echo $env:FALCON_INSTANCE
   ```

2. **Test Different URL Patterns:**
   ```powershell
   # Test base CDN
   Invoke-WebRequest -Uri "https://cdn.scs.static.lightning.force.com/"
   
   # Test without /resources/ prefix
   Invoke-WebRequest -Uri "https://cdn.scs.static.lightning.force.com/agent-svc-messaging/index.html"
   
   # Test with /resources/ prefix (usually fails)
   Invoke-WebRequest -Uri "https://cdn.scs.static.lightning.force.com/resources/agent-svc-messaging/index.html"
   ```

3. **Check DNS Resolution:**
   ```powershell
   nslookup cdn.scs.static.lightning.force.com
   nslookup stage.cdn.scs.static.lightning.force.com
   ```

**Solution:** Use production environment and correct URL pattern (without `/resources/`).

### Issue 4: Stage Environment Not Working

**Symptoms:**
- Stage deployment completes successfully
- Cannot access files via `stage.cdn.scs.static.lightning.force.com`
- DNS resolution fails for stage CDN

**Explanation:**
- Stage environment CDN endpoint doesn't exist in DNS
- Stage is for internal testing only, no public web serving
- Only production environment has functional CDN

**Solution:** Deploy to production environment for web access.

### Issue 5: Certificate Authentication Errors

**Symptoms:**
- `scsCopy` fails silently
- Connection timeout errors
- Authentication failures

**Diagnosis:**
```powershell
# Check certificate validity
openssl x509 -in certificates/client.pem -text -noout | Select-String "Subject:|Issuer:|Not After"

# Verify certificate files exist
Get-ChildItem certificates/
```

**Solution:**
```powershell
# Ensure all certificate environment variables are set
$env:MY_USER_CERT = "certificates/client.pem"
$env:MY_USER_KEY = "certificates/client-key.pem"
$env:MY_USER_CACERTS = "certificates/cacerts.pem"
```

### Issue 6: Build Failures

**Symptoms:**
- `npm run build` fails
- Missing dependencies
- TypeScript compilation errors

**Solutions:**
```powershell
# Clean install
Remove-Item node_modules -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item package-lock.json -ErrorAction SilentlyContinue
npm install

# Clear build cache
Remove-Item dist -Recurse -Force -ErrorAction SilentlyContinue
npm run build
```

## 🔐 Security Notes

### Certificate Management
- Certificates are used only for authentication, never uploaded
- Keep certificates secure and backed up
- Current certificates valid until: **August 6, 2026**
- Contact Salesforce infrastructure team for renewal

### Service Category
- App deploys under `agent-svc-messaging` category (hardcoded in binary)
- This is just a namespace - doesn't affect functionality
- Category name visible in URLs but doesn't impact app behavior

## 📊 Deployment Architecture

```
Local Development
       ↓
   Build Process (npm run build)
       ↓
   Static Files (dist/)
       ↓
   scsCopy Binary (mTLS Auth)
       ↓
Falcon SCS Storage (prod1-uswest2)
       ↓
CDN Distribution (cdn.scs.static.lightning.force.com)
       ↓
   Public Web Access
```

## 🧪 Testing Your Deployment

### 1. Verify Upload Success
```powershell
# Check if deployment completed without errors
echo "Upload completed successfully" should appear
```

### 2. Test Web Access
```powershell
# Test main app
Start-Process "https://cdn.scs.static.lightning.force.com/agent-svc-messaging/index.html"

# Test Teams tab
Start-Process "https://cdn.scs.static.lightning.force.com/agent-svc-messaging/index.html#/tab"
```

### 3. Validate All Assets
- Open browser Developer Tools (F12)
- Check Network tab for any 404 errors
- Verify all CSS, JS, and image files load correctly

## 🔄 Redeployment Process

```powershell
# 1. Make changes to your React app
# 2. Rebuild
npm run build

# 3. Redeploy
.\upload-prod.ps1

# 4. Verify changes
Start-Process "https://cdn.scs.static.lightning.force.com/agent-svc-messaging/index.html"
```

## 📝 Key Learnings

1. **Environment Matters**: Only production environment provides web access
2. **URL Pattern**: CDN serves files directly, not under `/resources/` path
3. **Binary Permissions**: Windows blocks downloaded executables by default
4. **Certificate Authentication**: Required for all Falcon SCS operations
5. **DNS Reality**: Stage CDN endpoints don't exist in production DNS

## 🆘 Emergency Troubleshooting

If deployment completely fails:

1. **Stop all processes:**
   ```powershell
   taskkill /f /im "scsCopy*" 2>$null
   ```

2. **Reset environment:**
   ```powershell
   Unblock-File -Path ".\scsCopyBinary\scsCopy"
   ```

3. **Verify basics:**
   ```powershell
   # Check certificates
   Get-ChildItem certificates/
   
   # Check build
   Get-ChildItem dist/
   
   # Test binary
   .\scsCopyBinary\scsCopy --help
   ```

4. **Contact Salesforce Infrastructure Team** if persistent issues occur.

## 📞 Support

For issues not covered in this guide:
- Check Salesforce internal documentation
- Contact your Salesforce infrastructure team
- Verify certificate validity and renewal status

---

**Last Updated:** January 2025  
**App Status:** ✅ Live in Production  
**CDN URL:** https://cdn.scs.static.lightning.force.com/agent-svc-messaging/index.html
